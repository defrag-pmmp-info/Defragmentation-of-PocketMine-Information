# 4.0チェンジログ
Minecraft: Bedrock Edition 1.18.0用

# 4.0.0
リリース 2021.12.1

このメジャーバージョンAPI4は重大なAPIの変更,新しいワールド形式のサポート,パフォーマンスの向上やネットワークの刷新を含めたコア全体の重大な変更に焦点を当てています。

## コア
### 一般
- RCON削除
  - [RconServer](https://github.com/pmmp/RconServer)で代用可能
- スポーンプロテクション削除
  - [BasicSpawnProtection](https://github.com/pmmp/BasicSpawnProtection)で代用可能
- 移動に関するアンチチートの削除
- GS4 QueryはRakLibが無効になったときに中断しなくなった
- プリプロセッサはコストが実益に見合わないためビルドから取り除かれた。使用は非推奨。
- タイトルバーからヒープメモリの使用量を削除
- `start.sh`はPHPバイナリが見つからなければ単にPHPバイナリがないと表示するようになった
- CLIオプションの`--bootstrap`を削除
- IPv6による接続をサポート
  - IPv6が無効化されていてもPHPバイナリはIPv6をサポートする必要がある。これはIPv4のみを使用している場合でもRakNetが接続パケットにおいてリンクローカルIPv6ループバックアドレスに送信する可能性があるため。
  - Minecraft BedrockがIPv6のサーバーをLAN上で検知できるようにデフォルトではポート`19133`がIPv6のために使われる。
  - GS4 Queryは`server.properties`の設定に従いIPv4とIPv6の両方でサポートされる。
  - `server.properties`に`enable-ipv6`, `server-ipv6`, `server-portv6`が追加(下を参照せよ)

### 依存関係の変更
- `pocketmine_chunkutils`PHP拡張を削除
- PHPのIPv6が必須になる
- 新規PHP拡張が必須となる
  - [crypto](https://github.com/bukka/php-crypto)
  - [chunkutils2](https://github.com/pmmp/ext-chunkutils2)
  - [gmp](https://www.php.net/manual/en/book.gmp.php)
  - [igbinary](https://github.com/igbinary/igbinary)
  - [leveldb](https://github.com/pmmp/php-leveldb) ([pmmp/leveldb](https://github.com/pmmp/leveldb/tree/mojang-compatible)でビルドされたもの)
  - [morton](https://github.com/pmmp/ext-morton)
- 以下のComposer依存関係が変更 ([以前のバージョン ->] 現在のバージョン)で記述
  - `pocketmine/bedrock-protocol` [7.0.0](https://github.com/pmmp/BedrockProtocol/releases/tag/7.0.0+bedrock-1.18.0).
  - `pocketmine/classloader` 0.1.0 -> [0.2.0](https://github.com/pmmp/ClassLoader/releases/tag/0.2.0) (**重大なAPIの変更, 新機能**).
  - `pocketmine/color` [0.2.0](https://github.com/pmmp/Color/releases/tag/0.2.0).
  - `pocketmine/errorhandler` [0.3.0](https://github.com/pmmp/ErrorHandler/releases/tag/0.3.0).
  - `pocketmine/locale-data` [2.0.16](https://github.com/pmmp/Language/releases/tag/2.0.16).
  - `pocketmine/log` 0.2.0 -> [0.4.0](https://github.com/pmmp/Log/releases/tag/0.4.0) (**小規模なAPIの変更**, see also [0.3.0](https://github.com/pmmp/Log/releases/tag/0.3.0)).
  - `pocketmine/nbt` 0.2.18 -> [0.3.0](https://github.com/pmmp/NBT/releases/tag/0.3.0) (**重大なAPIの変更**).
  - `pocketmine/raklib` 0.12.7 -> [0.14.2](https://github.com/pmmp/RakLib/releases/tag/0.14.2) (**重大なAPIの変更**, [0.13.0](https://github.com/pmmp/RakLib/releases/tag/0.13.0)も参照).
  - `pocketmine/raklib-ipc` [0.1.0](https://github.com/pmmp/RakLibIpc/releases/tag/0.1.0) (RakLibから抽出されたコンポーネント).
  - `pocketmine/snooze` 0.1.0 -> [0.3.0](https://github.com/pmmp/Snooze/releases/tag/0.3.0) (**小規模なAPIの変更**, [0.2.0](https://github.com/pmmp/Snooze/releases/tag/0.2.0)も参照)
  - `pocketmine/spl`削除
- Minecraft Bedrockのプロトコルは独立したレポジトリで開発する[pmmp/BedrockProtocol](https://github.com/pmmp/BedrockProtocol)
  - PM3と比較すると重大な変更がある。チェンジログを見ること。
- 以下のサブモジュールの削除
  - `resources/vanilla`: Composer依存関係で含まれる [`pocketmine/bedrock-data`](https://packagist.org/packages/pocketmine/bedrock-data).
  - `resources/locale`: Composer依存関係で含まれる [`pocketmine/locale-data`](https://packagist.org/packages/pocketmine/locale-data).
  - これによりサブモジュールなしでサーバーが起動可能になる
  - 残りのサブモジュール(DevTools, build/php)はサーバーのビルド/起動には必須ではない

### パフォーマンス
- `/op`, `/deop`, `/whitelist add`, `/whitelist remove`コマンドで不必要にプレイヤーデータが読み込まれなくなる。
- Timingsはより正確なパフォーマンスメトリクスを収集するためにより精度が高い`hrtime()`によるタイマーを使用する。
- クロージャーが内部イベントハンドラーコールに使われる。毎イベントごとに動的にコールバックを解決する必要のある3.xシステムより10-20%の性能向上。
- 大量のプラグインを読み込むときの起動時のパフォーマンスの向上
- [Worlds / Performance](#performance-2)と[Network / Performance](#performance-3)を参照。

### ツール
`tools/`ディレクトリに新規スクリプトが追加。これらのスクリプトはPocketMine-MPのコアを使う可能性があるがスタンドアローンで動作が意図されている。
 - `convert-world.php`: サーバーを動作させずにワールドを新形式にする
 - `compact-regions.php`: レガシーRegionのワールドを詰め直して無駄なディスクスペースを開放する
 - `generate-permission-doc.php`: コアパーミッションのMarkdownドキュメントを生成する ([example](https://gist.github.com/dktapps/eed6d6a4571f01b676236bf9ff2779b2)参照)
 - `simulate-chunk-selector.php`: 
 チャンク送信アルゴリズムのふるまいを貸しかする画像列を生成する。 [ffmpeg](https://ffmpeg.org/)のようなツールでつなぎ合わせて映像にできる。

### コマンド
- `/effect` 数字IDの廃止 エフェクト名がのみサポート
- `/enchant` 数字IDの廃止 エンチャント名がのみサポート
- `/give` 不正なNBTを持つアイテムをgiveできなくなった(e.g. 誤った型)。 PM3ではこれによりサーバークラッシュを引き起こしていた。
- `/give`にJava版のような様々なエイリアスが追加。`/give someone bonemeal`や`/give someone lapis_lazuli`などがid:metadataの代わりに使えるようになる。
- `/help`は`server.properties`の言語に従いローカライズされる。
- `/reload` 削除
- `/setworldspawn`はプレイヤーが実行したときに相対座標を受け取れる。
- `/status` ヒープメモリの使用量を削除
- バニラのものと同等の `/clear` が追加
- 以下のコマンドがローカライズされる
  - `/gc`
  - `/status`
  - `/op`
  - `/deop`
- 適切なパーミッションがないときに適切なメッセージではなく`commands.generic.permission`が送信される問題を修正
- コンソールで制御文字を入力後に一部のケースでコマンドが動かない問題を修正
- 負の座標の時に`/setworldspawn`が誤った地点を設定してしまう問題を修正

### 設定
- Worldプリセットは`pocketmine.yml`の`generator`キーから`preset`キーに変更
- `server.properties`や`pocketmine.yml`で不明なワールドジェネレーターが使用されるとワールド生成に失敗する。
- `server.properties`や`pocketmine.yml`で不正/誤ったワールド生成オプション(プリセット)が使用されるとワールド生成に失敗する。
- 以下の新たなオプションが`pocketmine.yml`に追加
  - `chunk-ticking.blocks-per-subchunk-per-tick` (デフォルト `3`): この値を増やすとランダムブロックアップデートの確率が上がる(例. 草の成長)
  - `network.enable-encryption` (デフォルト `true`): ネットワークパケットを暗号化するか否かを決める。
- 以下のオプションが`pocketmine.yml`から削除
  - `chunk-ticking.light-updates`: Since lighting is needed for basic vanilla functionality to work, allowing this to be disabled without disabling chunk ticking made no sense. If you don't want light calculation to occur, you can disable chunk ticking altogether by setting `chunk-ticking.per-tick` to `0` in `pocketmine.yml`.
  - `player.anti-cheat.allow-movement-cheats`
- 以下の新たなオプションが`server.properties`に追加
  - `enable-ipv6`: デフォルトで`on`。 これを無効化すると完全にIPv6サポートが無効化される。
  - `server-ipv6`: デフォルトで`::`(IPv4での`0.0.0.0`に相当)。ほとんどのユーザーはこの設定を変更する必要はない。そのためデフォルトでは`server.properties`に存在しない。
  - `server-portv6`: デフォルトで19133。IPv4とIPv6の両方を同じポートで起動することもできるが、Bedrockはデフォルトで19133をスキャンするためPMも同じポートをもちいる。

### ワールドハンドリング
#### インターフェース
- 初回ワールド生成時のスポーン地形チャンク生成の進捗がログに表示されるようになる。


#### 機能
- 1.12.xまでのMinecraft Bedrockワールドのサポート(1.13以降はまだ**サポートされない**。大規模で労力を要する別のフォーマット変更があるため)
- 非推奨のワールド形式の自動変換が実装された
- `leveldb`以外のすべてのフォーマットは非推奨となった。以下のワールドは**ロード時にleveldbに自動変換される**。
  - `mcregion`
  - `anvil`
  - `pmanvil`
- 既存のワールドの生成オプションがロード前に検証される。もし不正であればワールドの読み込みに失敗する。
- サーバーが読み込みに失敗したワールドを生成しようとする問題を修正
- すべてのワールドで建築高度が256までサポートされるようになる。(自動変換の恩恵)
- 拡張ブロックがサポートされる。(自動変換の恩恵)
- チャンク読み込み時に不正なブロックは正常な同等のブロックにできる限り変換される。これにより`update!`ブロックがワールドに出てしまう問題を修正。(これらはワールドエディタがメタデータを変えずにIDのみを変えることでブロックを消去したときに出現していた)
- 爆発は通常のブロックアップデートで処理と同じ標準メカニズムを用いるようになる。以前は標準アルゴリズムがどうにもならないほど効率が悪かったため専用のメカニズムが使われていた。この非効率性を改善したため、爆発も最小限の性能への影響にしつつ他のものと同じように扱えるようになった。
- チャンク生成時に`chunk has no loaders registered`というデバッグメッセージが流れ続ける問題を修正
- チャンクに不正なデータがあった様々なケースでサーバーがクラッシュしなくなりエラーがログされるようになった。タイルが衝突する位置に置かれた場合やタイルがロードされていない不正なチャンクにある場合も含まれる。
- チャンクが送信される前に生成前の同じチャンクを複数回プレイヤーが再要求してしまう問題を修正
- プレイヤーが頭の向きを変えたりジャンプするときにチャンクを再要求してしまう問題を修正

#### パフォーマンス
- `leveldb`が基本サポートのワールドフォーマットになる。優れたデザインによって根本的に領域ベースのフォーマットよりも速い。
- チャンクの部分保存(変更されたチャンクの下位コンポーネントのみの保存)が実装された。チャンク保存時のデータ量が劇的に削減され、**結果としてワールド保存にかかる時間が劇的に削減された**。これはleveldbワールド形式のモジュールデザインによって可能になった。この強化は領域ベースフォーマットでは実現不可能であった。
- 光量はすべてのチャンクでは保証されなくなる。必要に応じて計算される。
- Zオーダーカーブ(mortonコード)がブロックとチャンクのハッシュに使われる。これは多くの領域でハッシュテーブルのキーの衝突問題を解決することでパフォーマンスを大幅に改善する。
- `$update`が`true`の時の`World->setBlock()`の性能が35%ほど改善。
- `$update`が`false`の時の`World->setBlock()`の性能が30%ほど改善。

### ロガー
- 多くのコンポーネントは専用のロガーを持つようになった。メッセージに自動で[接頭辞]が追加される。
- メインロガーはミリ秒をタイムスタンプに含む。
- リーチ距離チェックでプレイヤーの行動が阻止されたときにデバッグメッセージが記録される。
- ワールドの読み込み/生成/変換にかかわる様々なメッセージとプラグインの読み込みエラーは`server.properties`で設定された言語に従いローカライズされる。
- 例外ログのフォーマットが変更された。例外情報は大きいブロックのメッセージで記録される。これによりコンソール余白を広くなって可読性が上がった。また、`ThreadedLoggerAttachment`が例外出力を乱す可能性も下げた。
- プラグインコマンドの名前やエイリアスに不正な文字が含まれているときにエラーメッセージを修正。
- `Server->forceShutdown()`が正常なシャットダウン以外の目的で使用されたときにEMERGENCYレベルのメッセージに記録される。

### ネットワーク
このバージョンではコヒーレンシ、信頼性、モジュール性の向上などを含めネットワークシステムの重大な変更を組み込んでいる。

#### パフォーマンス
- [`libdeflate`](https://github.com/ebiggers/libdeflate)は(任意で)送信側Minecraftパケット圧縮に用いられる。これはほとんどケースでzlibよりも倍以上高速で、パケット送信とネットワーク全体で大幅なパフォーマンスの向上が見込まれる。

#### Minecraft Bedrockパケット暗号化
- これはハッカーがプレイヤーのログインを盗聴し再生するリレーアタックを防止する。
- 新たな設定として`network.enable-encryption`(デフォルトで`true`)が`pocketmine.yml`に追加された。

#### エラーハンドリング
- `BadPacketException`のみがパケットデコード/ハンドリングでキャッチされるようになった。すべてのデコードが適切なエラーチェックを遂行する義務を負う。
  - `BadPacketException`をデコード中に投げられると`Packet processing error`というメッセージでキックされる。
  - 切断メッセージにはランダムな16進数IDが含まれ、サーバー管理者がプレイヤーから報告された問題を特定しやすくしている。
- 他のいかなるエラーが投げられるとサーバーはクラッシュする。`Internal server error`は削除された。
- クライアント方面へのパケットをサーバーに送信することは許されなくなった。これを行うとクライアントは`Unexpected non-serverbound packet`というメッセージでキックされる。
- 目的のポートにバインドできなかったときにサーバーがクラッシュしなくなった。サーバーはエラーを表示してクラッシュダンプを出すことなく正常に終了する。

#### 新たなパケットハンドリングシステム
- パケットハンドラーがNetworkSessionから専用のパケットハンドラー構造に分離された。
- ネットワークセッションはいつでも真に1つのハンドラーを持つ。これは可変であり、いつでも置き換えることができる。これによってパケットハンドルのロジックを複数のステージに分離することができた。
  - 誤ったタイミングで誤ったパケットが送られた際に未定義の動作が起こるのを防止する(そのまま無視される)
  - 状態特有でその時限りのロジックを作ることができるようになる。(例えば、厳密なリソースパックダウンロードの確認)
- パケットハンドラーは`Player`から取り除かれ、専用のユニットに存在するようになった。
- `Player`内のパケットハンドラーに固定化されていたほとんどすべてのゲームロジックは新たなAPIメソッドへ抽出された。詳細はPlayer APIの変更を見ること。

### プラグイン読み込み
- PharプラグインはDevToolsによって読み込まれるフォルダープラグインに依存できるようになった。
- 新規に「プラグイングレーリスト」機能が追加され、プラグイン読み込みでホワイトリスト/ブラックリスト化ができるようになった。 `plugin_list.yml`を見ること。

### 内部
- `pocketmine`サブディレクトリがsrcから削除された。[ComposerによるPSR-4オートロードが使用される。](https://github.com/pmmp/PocketMine-MP/blob/4.0.0/composer.json#L63)
- クラッシュダンプの表示がクラッシュダンプの生成から分離された。これにより既存のJSONデータからクラッシュダンプを表示することができる。
- 文字列をキーに持つ配列を直接イテレートすることが独自のPHPStanルールによりできなくなった。数字の文字列が配列のキーとして用いられたときに整数に変換されることに起因する。これにより様々な予期せぬ振る舞いが特にイテレーションにおいて発生していた。
  - 文字列のキーを持つ配列をイテレートするためには`Utils::stringifyKeys()`を使用する必要がある。
- 数字の文字列をキーにもつ配列に関連する様々なクラッシュを修正。

## API
### 一般
- `callable`が許可されていた殆どの場所は`\Closure`のみを許可されるようになる。これはクロージャーがより一貫性ある振る舞いを持ち性能が良いため。
- `void`と`?nullable`パラメータ/返り型が多くの場所で適用された。
- `pocketmine\metadata`名前空間以下のものとそれに関する実装が削除された。

### `plugin.yml`の変更点
#### 許可のネスト
`plugin.yml`での許可のネストはサポートされなくなった。`plugin.yml`での許可のグループ化には非常に分かりづらく一貫性のない振る舞いがあるため。
許可のネスト宣言をするのではなく、それぞれを分けて宣言すること。

_以前_:
```
permissions:
   pmmp:
     default: op
	 children:
	     pmmp.something:
		     default: op
         pmmp.somethingElse
		     default: op
```

_現在_:
```
permissions:
    pmmp.something:
        default: op
    pmmp.somethingElse
        default: op
```

#### `src-namespace-prefix`
新たな指示文`src-namespace-prefix`が導入される。以下のようなプラグイン構造にある無駄なサブディレクトリを削減可能。
例えば、以前では`pmmp\TesterPlugin\Main`がメインクラスであるプラグインはこのような構造だった。
```
|-- plugin.yml
|-- src/
    |-- pmmp/
        |-- TesterPlugin/
            |-- Main.php
            |-- SomeOtherClass.php
            |-- SomeNamespace/
                |-- SomeNamespacedClass.php
```
`src-namespace-prefix:pmmp\TesterPlugin`を`plugin.yml`に追加すると無駄なディレクトリを取り除き、このような構造にできる。
```
|-- plugin.yml
|-- src/
    |-- Main.php
    |-- SomeOtherClass.php
    |-- SomeNamespace/
        |-- SomeNamespacedClass.php
```

**ノート**: 昔の構造でもちゃんと動く。必ず変えなければならない変更ではない。

#### その他の変更点
- 正しくない構造のコマンドがより早期に検出され、より優雅に処理される。
- それぞれのコマンドについて`permission`を宣言する必要がある。以前は`permission`キーは任意であったため、コマンドが誰にでも使用できるようになっている場合があった。
  - これは潜在的なセキュリティリスクを理由に削除された。`plugin.yml`でのタイポで危険な機能を誰にでも使える状態になる可能性がある。
  - もし、誰にでも使用できるコマンドを作りたければ、許可の宣言で`default`を`true`にしてコマンドに割り当てること。
- すべての許可で`default`を宣言する必要がある。以前は`default`キーは任意であり、暗黙の全員拒否(PM4)またはopのみの許可(PM3)となっていた。

### ブロック
`VanillaBlocks`クラスが追加され、静的なメソッドで現在のブロックタイプを作れるようになった。定数が用いて`BlockFactory::get()`を呼び出すのではなくこれを用いたほうが良い。
- `BlockFactory`がシングルトンとなり、メソッドが静的でなくなった。`BlockFactory::whatever()`は`BlockFactory::getInstance()->whatever()`で置き換えられる。
- `BlockFactory->get()`は**非推奨**である。
  - 代替のケースでは`VanillaBlocks::WHATEVER_BLOCK()`で目的を達成できるであろう。
  - `BlockFactory`はデータベースやコンフィグ、ワールドのセーブデータなどの古いセーブデータからの読み込みのみに用いられるべきだ。
  - ブロックを名前で参照したければ、IDではなく名前を受け取る`StringToItemParser`の使用を考慮せよ。
- ブロックは`Position`を継承するのではなく、保持するようになった。`Block->getPosition()`が追加。
- IDが256より大きいブロックがサポートされる。
- ブロックのステートとバリアントメタデータは分離された。
  - バリアントはIDの拡張であり、不変である。
  - `Block->setDamage()`が削除。
- すべてのブロックはプロパティに応じたゲッターとセッターを持つようになった。例えば向き、着火/消火、色、その他多数。これらがメタデータの代わりに用いられる。
- タイルエンティティを必要とするブロックで`World->setBlock()`が使われたときに自動で生成/削除されるようになった。
- タイルエンティティが非推奨になるのと同時に、いくつかのタイルエンティティのAPIが対応する`Block`クラスで公開される。
- `pocketmine\tile`名前空間が`pocketmine\block\tile`名前空間に移動。
- `Block->recalculateBoundingBox()`と`Block->recalculateCollisionBoxes()`がブロックからの相対座標ではなく、絶対座標(`0,0,0`基準)を返すようになる。
- ブロックの破壊情報は動的な`BlockBreakInfo`ユニットに抽出された。以下のメソッドが移動。
  - `Block->getBlastResistance()` -> `BlockBreakInfo->getBlastResistance()`
  - `Block->getBreakTime()` -> `BlockBreakInfo->getBreakTime()`
  - `Block->getHardness()` -> `BlockBreakInfo->getHardness()`
  - `Block->getToolHarvestLevel()` -> `BlockBreakInfo->getToolHarvestLevel()`
  - `Block->getToolType()` -> `BlockBreakInfo->getToolType()`
  - `Block->isBreakable()` -> `BlockBreakInfo->isBreakable()`
  - `Block->isCompatibleWithTool()` -> `BlockBreakInfo->isToolCompatible()`
- 以下のAPIメソッドが追加
  - `Block->asItem()`: ブロックに対応するアイテムスタックを返す。
  - `Block->getModelPositionOffset()`: 例えば竹ブロックなどのブロックのバウンディングボックスへ座標をもとにしてオフセットを適用にするために用いられる。
  - `Block->isSameState()`: ブロックがパラメータで与えられたブロックとステート情報まで含めて同じか返す
  - `Block->isSameType()`: ブロックがパラメータで与えられたブロックとステート情報までは含めずに同じか返す
  - `Block->isFullCube()`
  - `Liquid->getMinAdjacentSourcesToFormSource()`: 現在のブロックが液体源となるために必要な隣接液体源ブロック数を返す。
- 以下のフックが追加
  - `Block->onAttack()`: サバイバルモードのプレイヤーがブロックを破壊するために左クリックをしたときに呼ばれる- `Block->onEntityLand()`: エンティティがブロックに(距離に関係なく)落ちてきたときに呼ばれる
  - `Block->onPostPlace()`: ワールドに設置された後すぐ呼ばれる。レールの接続やチェストの接続を処理する。
- 以下のAPIメソッドがリネーム
  - `Block->getDamage()` -> `Block->getMeta()`
  - `Block->onActivate()` -> `Block->onInteract()`
  - `Block->onEntityCollide()` -> `Block->onEntityInside()`
- 以下のAPIメソッドのシグネチャが変更
  - `Block->onInteract()`は`onInteract(Item $item, int $face, Vector3 $clickVector, ?Player $player = null) : bool`というシグネチャをもつ
  - `Block->getCollisionBoxes()`はfinalになった。`recalculateCollisionBoxes()`をオーバーライドすべきである。
- 以下のAPIメソッドが削除
  - `Block->canPassThrough()`
  - `Block->setDamage()`
  - `Block::get()`: 以前から`BlockFactory::get()`で置き換え済み
  - `Block->getBoundingBox()`
- 以下のクラスが追加
  - `inventory\CraftingTableInventory`: 作業台の3x3のクラフティンググリッドを表す。
  - `utils\LeverFacing`
  - `utils\MinimumFlowCostCalculator`: `Liquid`に埋め込まれていたフロー計算のロジックをカプセル化する。
- 以下のクラスがリネーム
  - `BlockIds` -> `BlockLegacyIds`
  - `CobblestoneWall` -> `Wall`
  - `NoteBlock` -> `Note`
  - `SignPost` -> `FloorSign`
  - `StandingBanner` -> `FloorBanner`
- 以下のクラスが削除
  - `Bricks`
  - `BurningFurnace`
  - `CobblestoneStairs`
  - `Dandelion`
  - `DoubleSlab`
  - `DoubleStoneSlab`
  - `EndStone`
  - `GlowingRedstoneOre`
  - `GoldOre`
  - `Gold`
  - `IronDoor`
  - `IronOre`
  - `IronTrapdoor`
  - `Iron`
  - `Lapis`
  - `NetherBrickFence`
  - `NetherBrickStairs`
  - `Obsidian`
  - `PurpurStairs`
  - `Purpur`
  - `QuartzStairs`
  - `Quartz`
  - `RedSandstoneStairs`
  - `RedSandstone`
  - `SandstoneStairs`
  - `Sandstone`
  - `StainedClay`
  - `StainedGlassPane`
  - `StainedGlass`
  - `StoneBrickStairs`
  - `StoneBricks`
  - `StoneSlab2`
  - `StoneSlab`
  - `Stone`
  - `WallBanner`
  - `WallSign`
  - `Wood2`
- `BlockToolType`の定数から`TYPE_`接頭辞が取り除かれた。

### コマンド
- 以下のクラスが削除
  - `PluginIdentifiableCommand` - `PluginOwned`と`PluginOwnedTrait`を用いよ
  - `RemoteConsoleCommandSender`
- 以下のAPIメソッドのシグネチャが変更
  - `Command->setPermission()` 引数が必須となる(nullでも良い)
  - `CommandSender->setScreenLineHeight()` 引数が必須となる(nullでも良い)
  - `Command->getDescription()`は`Translatable|string`を返す
  - `Command->getUsage()`は`Translatable|string`を返す
  - `Command->setDescription()`は`Translatable|string`を受け取る
  - `Command->setUsage()`は `Translatable|string`を受け取る
- `Command->setPermission()`は存在しない許可を含む文字列を受け取ると例外を投げるようになる。以前は暗黙にopがコマンドを使えるようになっていたが、期待された動作ではなかったはずだ。
  - これは許可の宣言のtypoやし忘れで引き起こされていた。
- スペースを含むコマンド名はサポートされなくなった。
- コマンドの使い方と説明の文字列は自動的に翻訳(translate)されなくなった(生の文字列の代わりに`Translatable`を用いよ)。

### エンティティ
#### 一般
- `Entity`は`Location`を継承しなくなった。`Entity->getLocation()`と`Entity->getPosition()`を代わりに用いよ。
- エンダーインベントリがリファクタリングされた。2つの部分に分けられる。
  - `EnderChestInventory`は一時的な入口の役割を果たす「インベントリ」で、プレイヤーのエンダーインベントリのプロキシのように振る舞う。`Position`をホルダーとしてもつ。プレイヤーがインベントリを閉じると破棄される。
  - `PlayerEnderInventory`はストレージ部分である。これは`Human`で保持されいかなるブロック情報も含まない。
  - プレイヤーにエンダーインベントリを開けさせたければ、`Player->setCurrentWindow(new EnderChestInventory($blockPos, $player->getEnderInventory()))`を用いよ。
- 以下の公開フィールドが削除。
  - `Entity->chunk`: エンティティは自身がどのチャンクにいるかを把握しない (`World`が管理する).
  - `Entity->height`: `EntitySizeInfo`に移動`Entity->size`を用いよ
  - `Entity->width`: `EntitySizeInfo`に移動`Entity->size`を用いよ
  - `Entity->eyeHeight`: `EntitySizeInfo`に移動`Entity->size`を用いよ
- 以下のAPIメソッドが追加
  - `Entity->getFallDistance()`
  - `Entity->setFallDistance()`
  - `ItemEntity->getDespawnDelay()`
  - `ItemEntity->setDespawnDelay()`
  - `Living->calculateFallDamage()`: これは`protected`であり子クラス独自のダメージロジックで上書きできる。
  - `Human->getHungerManager()`
  - `Human->getXpManager()`
 以下のメソッドのシグネチャが変更
  - `Entity->entityBaseTick()`が`protected`に
  - `Entity->move()`が`protected`に
  - `Entity->setPosition()`が`protected`に (`Entity->teleport()`を用いよ).
  - `Entity->setPositionAndRotation()`が`protected`に (`Entity->teleport()`を用いよ).
  - `Living->knockBack()`は`float, float, float`を受け取る (前半2つの引数が削除).
  - `Living->getEffects()`は`Effect[]`ではなく`EffectManager`を返す
  - `Location->__construct()`は`?World $world`を4番目の引数として受け取る。すべての引数が必須となった。
- 以下のクラスが追加
  - `effect\EffectManager`: `Living`から抽出されたエフェクト管理の機能を持つ
  - `HungerManager`: `Human`から抽出された空腹管理機能を持つ
  - `ExperienceManager`: `Human`から抽出された経験値管理機能を持つ
- 以下のAPIメソッドが移動/リネーム
  - `Entity->fall()` -> `Entity->onHitGround()` (アクセス権限が`public`から`protected`に)
  - `Living->removeAllEffects()` -> `EffectManager->clear()`
  - `Living->removeEffect()` -> `EffectManager->remove()`
  - `Living->addEffect()` -> `EffectManager->add()`
  - `Living->getEffect()` -> `EffectManager->get()`
  - `Living->hasEffect()` -> `EffectManager->has()`
  - `Living->hasEffects()` -> `EffectManager->hasEffects()`
  - `Living->getEffects()` -> `EffectManager->all()`
  - `Human->getFood()` -> `HungerManager->getFood()`
  - `Human->setFood()` -> `HungerManager->setFood()`
  - `Human->getMaxFood()` -> `HungerManager->getMaxFood()`
  - `Human->addFood()` -> `HungerManager->addFood()`
  - `Human->isHungry()` -> `HungerManager->isHungry()`
  - `Human->getEnderChestInventory()` -> `Human->getEnderInventory()`
  - `Human->getSaturation()` -> `HungerManager->getSaturation()`
  - `Human->setSaturation()` -> `HungerManager->setSaturation()`
  - `Human->addSaturation()` -> `HungerManager->addSaturation()`
  - `Human->getExhaustion()` -> `HungerManager->getExhaustion()`
  - `Human->setExhaustion()` -> `HungerManager->setExhaustion()`
  - `Human->exhaust()` -> `HungerManager->exhaust()`
  - `Human->getXpLevel()` -> `ExperienceManager->getXpLevel()`
  - `Human->setXpLevel()` -> `ExperienceManager->setXpLevel()`
  - `Human->addXpLevels()` -> `ExperienceManager->addXpLevels()`
  - `Human->subtractXpLevels()` -> `ExperienceManager->subtractXpLevels()`
  - `Human->getXpProgress()` -> `ExperienceManager->getXpProgress()`
  - `Human->setXpProgress()` -> `ExperienceManager->setXpProgress()`
  - `Human->getRemainderXp()` -> `ExperienceManager->getRemainderXp()`
  - `Human->getCurrentTotalXp()` -> `ExperienceManager->getCurrentTotalXp()`
  - `Human->setCurrentTotalXp()` -> `ExperienceManager->setCurrentTotalXp()`
  - `Human->addXp()` -> `ExperienceManager->addXp()`
  - `Human->subtractXp()` -> `ExperienceManager->subtractXp()`
  - `Human->getLifetimeTotalXp()` -> `ExperienceManager->getLifetimeTotalXp()`
  - `Human->setLifetimeTotalXp()` -> `ExperienceManager->setLifetimeTotalXp()`
  - `Human->canPickupXp()` -> `ExperienceManager->canPickupXp()`
  - `Human->onPickupXp()` -> `ExperienceManager->onPickupXp()`
  - `Human->resetXpCooldown()` -> `ExperienceManager->resetXpCooldown()`
- 以下のAPIメソッドが削除
  - `Human->getRawUniqueId()`: `Human->getUniqueId()->getBytes()`を用いよ
- 以下のクラスが削除
  - `Creature`
  - `Damageable`
  - `Monster`
  - `NPC`
  - `Rideable`
  - `Vehicle`
- `Skin`は生成時に不正なデータが与えられたときに例外を投げる
- `Living->lookAt()`が目の高さを考慮するようになる。

#### エフェクト
- すべての`Effect`関連クラスが`pocketmine\entity\effect`名前空間に移動
- `Effect`クラスに埋め込まれていたエフェクト機能が複数のクラスに切り分けられた。以下のクラスが追加
  - `AbsorptionEffect`
  - `HealthBoostEffect`
  - `HungerEffect`
  - `InstantDamageEffect`
  - `InstantEffect`
  - `InstantHealthEffect`
  - `InvisibilityEffect`
  - `LevitationEffect`
  - `PoisonEffect`
  - `RegenerationEffect`
  - `SaturationEffect`
  - `SlownessEffect`
  - `SpeedEffect`
  - `WitherEffect`
- `VanillaEffects`クラスが追加。以前の`Effect::getEffect()`の不便さをなくすために、すべてのバニラのエフェクトを静的メソッドとして公開する。
  - 例: `Effect::getEffect(Effect::NIGHT_VISION)`は`VanillaEffects::NIGHT_VISION()`で置き換えらえる。
- 負のエフェクトの強さは動作が未定義であることを理由に明示的に禁止された。
- MCPEエフェクトIDとPocketMine-MP内部エフェクトIDの境界がより明確になった。
  - IDハンドリングは`pocketmine\data\bedrock\EffectIdMap`に移動した。
  - すべてのエフェクトID定数が`Effect`から削除された。何らかの理由でレガシーIdを使う必要があれば`pocketmine\data\bedrock\EffectIds`を用いること。
- 以下のAPIメソッドが移動
  - `Effect->getId()` -> `EffectIdMap->toId()`
  - `Effect::registerEffect()` -> `EffectIdMap->register()`
  - `Effect::getEffect()` -> `EffectIdMap->fromId()`
  - `Effect::getEffectByName()` -> `StringToEffectParser->parse()`
- `StringToEffectParser`シングルトンが追加
  - 独自のエイリアスがサポートされる
  - `/effect`のエフェクト名サポートのために用いられる。

#### 実行時エンティティNBT
- エンティティは実行時にNBTを使用できなくした
- `Entity->namedtag`は削除
- `Entity->saveNBT()`は以前のものを変更するのではなく、新規作成された`CompoundTag`を返すようになる。
- `Entity->initEntity()`は引数として`CompoundTag`を受け取るようになる。

#### エンティティの生成
- `Entity::createEntity()`が削除。これは実行時に新規エンティティを生成するのに必要ではなくなった。単に`new YourEntity`とせよ。
- `Entity`子クラスのコンストラクタは普通のクラスと同様にいかなるシグネチャも許容する。
- NBTからのエンティティの読み込みは`EntityFactory`でハンドルされるようになった。`Entity::createEntity()`の振舞いとはかなり異なる。`YourEntity::class`の代わりにMinecraft save IDを登録し、エンティティをNBTとワールドから再生成するためのコールバックが必要となる。
  - `EntityFactory`はシングルトンである。`EntityFactory::getInstance()`でインスタンスを得られる。
  - 生成コールバックは`EntityFactory->register()`で登録される
  - 生成コールバックは`function(World, CompoundTag) : Entity`というシグネチャを持つ必要がある。
  - これにより`Entity`サブクラスはどのようなコンストラクタ引数を持てるようになった。
  - 特定のデータがいつでも提供されることを必須とすることも出来るようになった。例えば、ブロックの種類を指定せずに`FallingBlock`を生成できるというのはあまり合理的ではない。
  - 例
    - `ItemEntity`は`Item`をコンストラクタで要求する。そのため生成コールバックの中でNBTからItemをでコードしコンストラクタに渡す。
    - `Painting`は`PaintingMotive`をコンストラクタで要求する。そのため生成コールバックの中で受け取ったNBTに基づいてどの`PaintingMotive`を渡すかを決める。
    - 他の例は`EntityFactory`を見よ
- `EntityFactory->register()`(以前の`Entity::registerEntity()`)はfalseを返すのではなく例外を投げるようになった。
- 以下のAPIメソッドが移動
  - `Entity::registerEntity()` -> `EntityFactory->register()`
- 以下のクラスのコンストラクタが変更
  - すべてのプロジェクタイルの子クラスは`?Entity $thrower`引数を要求する
  - `Arrow->__construct()`は`bool $critical`引数を要求する(`$thrower`引数に加えて)
  - `ExperienceOrb->__construct()`は`int $xpValue`引数を要求する
  - `FallingBlock->__construct()`は`Block $block`引数を要求する
  - `ItemEntity->__construct()`は`Item $item`引数を要求する
  - `Painting->__construct()`は`PaintingMotive $motive`を要求する
  - `SplashPotion->__construct()`は`int $potionId`要求する
- 以下のAPIメソッドが削除
  - `Entity::createBaseNBT()`: `new YourEntity`と適切なAPIメソッドを用いよ
  - `Entity->getSaveId()`
  - `Entity::getKnownEntityTypes()`
  - `Entity::createEntity()`: `new YourEntity`を用いよ

